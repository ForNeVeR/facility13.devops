---
- hosts: newsboat.org
  become: true

  vars_files:
    - secrets.yml

  vars:
    gandi_config_path: /etc/letsencrypt/gandi.ini

  tasks:
    - name: Install the required packages
      apt:
        name: python3-certbot-dns-gandi
        state: present
        cache_valid_time: 3600
      notify: run certbot # only required once, after installation, it will configure renewal during the run

    - name: Ensure the configuration file for gandi renewal exists
      ansible.builtin.template:
        src: gandi.ini.j2
        dest: '{{ gandi_config_path }}'
        owner: root
        group: root
        mode: u=rw,go=

  handlers:
    - name: run certbot
      command: certbot certonly --authenticator dns-gandi --dns-gandi-credentials {{ gandi_config_path }} -d newsboat.org
